## Network > Load Balancer > コンソール使用ガイド
### ロードバランサー作成
TOASTのロードバランサーコンソールで設定値を入力するだけで、簡単にロードバランサーを作成できます。

#### ロードバランサー情報
ロードバランサーの基本情報を入力します。必要な項目は次のとおりです。

* 名前：ロードバランサーの名前を入力します。
* 説明：ロードバランサーの説明を記述します。
* Network (Subnet)：ロードバランサーが接続されるVPCのサブネットを指定します。

#### リスナー登録
ロードバランサーが処理するトラフィックの属性を定義します。TOASTのロードバランサーは基本的に1つのリスナーを持ち、今後ロードバランサーの詳細画面で追加作成や削除を行えるようになります。

* ロードバランシング方式：ロードバランサーがトラフィックを分散する方式を決定します。 ROUND_ROBIN/LEAST_CONNECTIONS/SOURCE_IPの中から1つを選択します。
* プロトコル：ロードバランサーが処理するトラフィックのプロトコルを指定します。 TCP/HTTP/HTTPS/TERMINATED_HTTPSの中から1つを選択します。
* ロードバランサーポート：基本リスナーがトラフィックを受信するポートを指定します。
* インスタンスポート：ロードバランサーのメンバーのポートを指定します。ロードバランサーポートに流入するトラフィックは、メンバーインスタンスのインスタンスポートに伝達されます。

> [参考]ロードバランサーポートとインスタンスポートは、1から65535の間の値を持ちます。

> [注意]ロードバランサーポート、インスタンスポート、そしてプロトコルはリスナー作成後の変更ができません。

* SSL証明書：プロトコルにTERMINATED_HTTPSを選択する場合、使用する証明書を登録します。プロトコルにTERMINATED_HTTPSを選択した時のみ活性化します。

> [参考] TERMINATED_HTTPS証明書の登録方法
>
> ロードバランサーのリスナープロトコルをTERMINATED_HTTPSに指定した場合、SSL証明書を登録するボタンが有効になります。
>
> 登録する必要があるファイルは、‘証明書’と‘秘密鍵’です。‘秘密鍵’はサーバー証明書に含まれている公開鍵のペアになる秘密鍵を意味します。
>
> ‘証明書’は下記のようにx.509 PEM形式に従います。
>
>     -----BEGIN CERTIFICATE-----
>     (内容省略)
>     -----END CERTIFICATE-----
>
>
> サーバー証明書とチェーン証明書(Chain Certificate, Intermediate Certificate)を一緒に登録する必要がある時は、サーバー証明書とチェーン証明書を1つのファイルで作って登録する必要があります。
>
> 証明書ファイルを1つで作る時は、ファイルの最上段にサーバー証明書を記述し、その下にチェーン証明書を記述する必要があります。チェーン証明書は順序に関係なく記述できます。
>
>サーバー証明書1個とチェーン証明書2個を1つの証明書ファイルで作ると次のような形式になります。
>
>
>      -----BEGIN CERTIFICATE-----
>      (サーバー証明書の内容省略)
>      -----END CERTIFICATE-----
>      -----BEGIN CERTIFICATE-----
>      (チェーン証明書#1内容省略)
>      -----END CERTIFICATE-----
>      -----BEGIN CERTIFICATE-----
>      (チェーン証明書#2内容省略)
>      -----END CERTIFICATE-----
>
>
>
> ‘秘密鍵’は、サーバー証明書に含まれている公開鍵に対応する鍵ファイルです。
>
> PKCS#1またはPKCS#8 PEM形式のファイルを登録できます。
>
>
>
>      -----BEGIN RSA PRIVATE KEY-----
>      (秘密鍵の内容省略)
>      -----END RSA PRIVATE KEY-----
>
>または
>
>      -----BEGIN PRIVATE KEY-----
>      (秘密鍵の内容省略)
>      -----END PRIVATE KEY-----



状態確認のための設定もリスナー作成時に決定します。 TOASTのロードバランサーはリスナーごとに状態確認動作を定義できます。必要な項目は次のとおりです。

* 状態確認プロトコル：状態確認時に使用するプロトコルを決定します。TCP/HTTP/HTTPSの中から1つを選択します。
* 状態確認ポート：状態確認を行うメンバーインスタンスのポートを決定します。
* HTTPメソッド：状態確認時に使用するHTTPメソッドを選択します。状態確認プロトコルでHTTPまたはHTTPSを選択した時のみ活性化します。現在はGETのみをサポートしています。
* HTTP状態コード：状態確認時に正常レスポンスとみなすHTTP状態コードを入力します。状態確認プロトコルにHTTPまたはHTTPSを選択した時のみ活性化します。現在はGETのみをサポートしています。
* URL：状態確認を行うメンバーインスタンスのパスを指定します。状態確認プロトコルでHTTPまたはHTTPSを選択した時のみ活性化します。
* 状態確認周期：状態確認の周期を入力します。単位は秒で、指定された周期ごとに状態確認を行います。
* 最大レスポンス待機時間：状態確認後、正常レスポンスを待機する最大時間を指定します。単位は秒で、指定された待機時間を超えると失敗とみなします。
* 最大再試行回数：状態確認時に繰り返し試行する最大回数を指定します。最大再試行回数が2以上の場合、状態確認に対する正常レスポンスがなかったからといって、すぐに失敗とはみなしません。失敗した回数が最大再試行回数に達した場合、そのインスタンスを負荷分散対象から除外します。

最後に接続に関する設定を指定します。

* セッション持続性：セッションを維持するため、リクエストに対するレスポンスを特定インスタンスでのみ行うように作成する設定です。 No Session Persistence/APP_COOKIE/HTTP_COOKIE/SOURCE_IPの中から1つを選択できます。
* 接続制限：基本リスナーが同時に維持するTCP接続の数を指定します。値を入力していない場合、基本値の2000に設定されます。
* Keepalive Timeout ：クライアント及びサーバーとのセッション維持時間を秒単位で指定します。ロードバランサーは、相手側がセッションを維持する限り、この時間の間はセッションを維持します。サーバーに設定したkeepalive timeoutの値をここに設定することを推奨します。基本値は300秒に設定されます。
* Proxy Protocol ：ロードバランサーがプロキシプロトコルをサポートするようにできます。サーバーでクライアントのIPを知るためにプロキシプロトコルを使用するように設定した場合にのみ、この値を有効にする必要があります。TCPとHTTPSプロトコルを使用する場合にのみ利用できます。


#### メンバー登録
ロードバランサー作成時、メンバーに登録するインスタンスを指定します。メンバー登録はロードバランサー作成後に行ってもかまいません。ロードバランサーが接続されたVPCに属するインスタンスのみメンバーに登録できます。

### ロードバランサーの詳細確認
ロードバランサーの作成を終えたら、再びロードバランサーリスト画面に戻ります。ロードバランサーリスト画面では作成されたロードバランサーの基本情報を確認できます。リスト画面に表示される項目は次のとおりです。

* 名前：ロードバランサー作成時に指定したロードバランサーの名前です。
* IPアドレス：ロードバランサーに接続されたVPCから割り当てられたプライベートIPです。 VPC内部ではこのIPを通してロードバランサーにアクセスできます。VPCの外部からロードバランサーにアクセスするためにはFloating IPを接続する必要があります。
* ロードバランサーポート/インスタンスポート：ロードバランサーに属するリスナーのポートとインスタンスポートのペアです。
* ネットワーク：ロードバランサーに接続されたVPCの名前とサブネットCIDRです。
* プロトコル：ロードバランサーに属するリスナーのプロトコルです。
* Provisioning Status (作成状態)：ロードバランサーの作成状態を表します。ACTIVEと表記されていれば、正常に作成されたということです。

> [参考]ロードバランサーの作成状態は次の中から1つが決定されます。

> | 状態 | 意味 |
> |--|--|
> | PENDING_CREATE | ロードバランサー作成中 |
> | ACTIVE | ロードバランサー作成完了 |
> | PENDING_ERROR | ロードバランサー作成失敗 <br> この場合は管理者にお問い合わせください。 |

### ロードバランサーの修正
ロードバランサーリスト画面でロードバランサーを選択すると、画面下段に選択したロードバランサーの詳細画面が表示されます。詳細画面は3つのタブで区分されます。各々のタブの説明は次のとおりです。

* ロードバランサー詳細情報：選択したロードバランサーの詳細情報が表示されます。選択したリスナーの名前と説明を変更できます。
* リスナー：選択したロードバランサーに作成されたリスナーの詳細設定を確認できます。リスナーの新規追加や、既存リスナーの削除を行えます。
* インスタンス：選択したロードバランサーのメンバーに登録されたインスタンスリストを確認できます。新たなインスタンスをメンバーに登録したり、既存メンバーを除外したりできます。

> [参考]ロードバランサーが接続されたVPCとIPアドレスは変更できません。

#### リスナーの追加
ロードバランサーの詳細画面でリスナータブを選択した後、リスナー追加ボタンを押すと、リスナーを追加できます。リスナー追加に必要な項目は、ロードバランサー作成時に基本リスナーで必要な項目と同じです。リスナー追加時、既に存在していたリスナーが使用していたロードバランサーポートは使用できません。

#### リスナーの修正
修正したいリスナーの修正ボタンを押すと、リスナーの設定を修正できます。

> [参考]リスナーのプロトコル、ロードバランサーポートそしてインスタンスポートは変更できません。

#### リスナーの削除
削除したいリスナーの削除ボタンを押すと、そのリスナーは削除されます。ただし、選択したロードバランサーにリスナーが1つしか存在しない場合は削除できません。

> [注意]リスナーの追加/修正/削除は、ロードバランサーの再起動を引き起こします。つまり、瞬間的にロードバランサーの動作が止まるので、予期せぬ障害を誘発する場合があります。リスナー変更作業はサービスに影響を与えない時間に進行する必要があります。

#### メンバーの追加
インスタンスタブで新たなインスタンスをロードバランサーのメンバーに登録できます。追加できるインスタンスは、ロードバランサーが接続されたVPCに制限されます。

#### メンバーの非活性化
メンバーインスタンスのうち、臨時でサービスから除外したい場合、非活性化させることができます。除外するインスタンスで使用項目の`True`を選択すると、 `False`に変更されて非活性化されます。

#### メンバーの削除
メンバーインスタンスのうち、今後使用しないインスタンスは削除できます。除外するインスタンスのインスタンス接続解除ボタンを押すと、選択したロードバランサーのメンバーから削除されます。ロードバランサーのメンバーから削除されても、インスタンスは削除されません。

> [注意]メンバーの追加/非活性化/削除はロードバランサーの再起動を引き起こします。つまり、瞬間的にロードバランサーの動作が止まるので、予期せぬ障害を誘発する場合があります。メンバー変更作業はサービスに影響を与えない時間に進行する必要があります。

### ロードバランサーの削除
ロードバランサーのリスト画面で、削除したいロードバランサーを選択した後に削除ボタンを押すと、そのロードバランサーが削除されます。


