## Network > Load Balancer > 개요

TOAST는 로드밸런서를 제공합니다. 로드밸런서를 이용하면,

- 인스턴스 하나로 처리하기 힘든 부하를 여러 대의 인스턴스로 분산하여 처리량을 늘릴 수 있습니다.
- 장애가 발생했거나 점검 중인 인스턴스를 자동으로 서비스에서 제외시켜 가용성을 높일 수 있습니다.

### 기본 구성

로드밸런서를 생성할 때, [VPC]()의 [서브넷]()을 반드시 지정해야 합니다. 지정된 서브넷으로부터 IP를 할당받아 로드밸런서의 IP로 사용하게 됩니다. 기본적으로 지정된 서브넷과 같은 VPC에 속한 인스턴스들만 멤버로 추가할 수 있으며, 멤버로 추가된 인스턴스들에게 부하를 분산하게 됩니다. 다른 VPC에 속한 인스턴스를 추가할 수 없습니다.

로드밸런서는 반드시 하나 이상의 리스너를 갖게 됩니다. 리스너는 로드밸런서로 유입되는 트래픽에 대한 정의입니다. 리스너 별로 트래픽을 수신할 포트와 프로토콜을 정의하여, 필요한 경우 로드밸런서에 리스너를 추가하거나 삭제하여 하나의 로드밸런서로 다양한 트래픽을 처리하도록 구성할 수 있습니다. 예를 들어, HTTP 트래픽을 수신할 80 포트 리스너와 HTTPS 트래픽을 수신할 443 포트 리스너를 두는 것이 대표적인 웹서버용 로드밸런서 구성입니다.

> [주의] TOAST의 로드밸런서에서 동일한 수신 포트를 가지는 리스너를 중복해서 생성할 수 없습니다.

TOAST의 로드밸런서는 [DSR \(Direct Server Return\)]()을 지원하지 않으며, 기본적으로 프록시 모드로만 동작합니다. 즉, 로드밸런서의 멤버인 인스턴스에서는 원본 IP가 로드밸런서의 IP로 보이며, 최종 사용자 입장에서는 로드밸런서가 요청에 대해 응답한 것처럼 보입니다. 서버 단에서 최종사용자의 IP를 확인하려면, TOAST의 로드밸런서에서 제공하는 HTTP의 [X-Forwarded-For]() 헤더를 사용하거나, TCP의 경우 [Proxy Protocol]()을 사용하여야 합니다.

### 지원 프로토콜

TOAST의 로드밸런서는 현재 아래와 같은 프로토콜을 지원합니다.

* TCP
* HTTP
* HTTPS
* TERMINATED_HTTPS

위의 프로토콜 중 TERMINATED_HTTPS 프로토콜은 HTTPS 트래픽을 수신하여 서버 측에는 HTTP 트래픽으로 전달하는 방식입니다. TERMINATED_HTTPS 프로토콜을 사용하는 경우 최종 사용자와 로드밸런서 사이에서는 HTTPS로 통신함으로써 높은 보안성을 확보하고, 서버에게는 HTTP 트래픽을 넘겨줌으로써 복호화에 드는 서버 측 CPU 부하를 줄일 수 있습니다. 이 프로토콜을 사용하려면 반드시 인증서를 로드밸런서에 등록해야 합니다.

### 로드밸런싱 방식

TOAST의 로드밸런서는 총 세 가지 로드밸런싱 방식을 지원합니다.

* Round Robin (순차 선택): 트래픽을 전달할 인스턴스를 순차적으로 선택하는, 가장 기본적이고 대중적인 로드밸런싱 방식입니다. 멤버로 참여하는 인스턴스들이 데이터베이스를 통해 정보를 공유하는 경우나 모든 인스턴스가 같은 요청에 대해서 동일한 응답을 하는 경우에 사용할 수 있는 방식입니다.

* Least Connections (최소 연결 우선 선택): 현재 TCP 연결 수가 가장 작은 인스턴스를 선택하는 방식입니다. 즉, TCP 연결 수를 기준으로 하여 인스턴스들의 부하 상태를 파악하고 멤버 중 가장 부하가 적은 인스턴스로 보내 인스턴스의 부하를 가능한 균등하게 유지합니다. 요청에 따른 처리 부하가 변동이 심할 때 적용한다면, 특정 인스턴스에 부하가 집중되는 상황을 방지할 수 있습니다.

* Source IP (원본 IP 기준 선택): 요청자의 원본 IP를 해싱하여 처리할 인스턴스를 선택하는 방식 입니다. 이 알고리즘을 사용하는 경우, 동일한 IP에서 들어오는 요청은 항상 동일한 인스턴스로 전달됩니다. 한 사용자에 대한 세션을 유지하고 똑같은 인스턴스에서 처리하고자 할 때 사용하면 유용합니다.

### 연결 제한

TOAST의 로드밸런서는 QoS 보장을 위해 리스너별로 동시에 유지 가능한 연결 수를 제한하고 있습니다. TOAST의 로드밸런서의 기본 연결 제한 값은 2000이며, 필요에 따라 조정할 수 있습니다.

> [참고] 현재 사용 중인 로드밸런서의 연결 수 모니터링 기능은 추후 공개될 예정입니다.

### 세션 지속성

서비스에 따라 사용자 정보를 유지할 필요가 있거나 요청이 특정 서버에게만 전달되어야 하는 경우, 세션을 관리하여 사용자의 정보를 유지하게 됩니다. 이 때 로드밸런서를 적용한다면, 앞서 설명한 로드밸런싱 방식에 따라 클라이언트-서버 간의 연결/끊김을 반복하게 되어 세션 관리에 어려움을 겪게 됩니다. 이러한 상황을 극복하기 위해 TOAST의 로드밸런서는 세션 유지 기능을 제공합니다.

TOAST의 로드밸런서에서 지원하는 세션 유지 방식은 다음과 같습니다.

* No Session Persistence (세션 유지 안함): 세션 유지를 하지 않는 방식입니다.

* Source IP (원본 IP에 의한 세션 관리): 요청자의 원본 IP를 기준으로 세션을 유지하는 방식입니다. 이를 위해 최초 요청시 로드밸런싱 방식에 의해 선택된 인스턴스와 원본 IP 사이의 맵핑 테이블을 내부적으로 보관합니다. 이후 같은 원본 IP를 가진 요청이 들어오면 맵핑 테이블을 확인하여 첫 요청에 응답한 인스턴스로 전달하게 됩니다. TOAST의 로드밸런서는 최대 10000개의 원본 IP에 대한 맵핑을 저장할 수 있습니다. TCP 프로토콜 리스너에서 세션을 유지하도록 설정하고 싶다면, 이 방식을 사용해야 합니다.

* APP Cookie (응용에 의한 세션 관리): 서버측에서 내려주는 명시적인 쿠키 설정을 통해 세션을 유지하는 방식입니다. 최초 요청시 서버는 자신에게 설정된 쿠키 값를 설정하도록 HTTP의 `Set-Cookie` 헤더를 통해 전달해야 합니다. 이 때, TOAST의 로드밸런서는 서버 응답 중 지정된 쿠키가 있는지 검사하여, 쿠키가 있다면 내부적으로 쿠키와 서버 ID간의 맵핑을 유지하게 됩니다. 이후 클라이언트가 `Cookie` 헤더에 지정된 키값을 넣어서 보내면 TOAST의 로드밸런서가 키값에 대응하는 서버로 요청을 전달하게 됩니다. 쿠키-서버 ID간의 맵핑은 3시간 동안 사용되지 않으면 삭제됩니다. 세션 관리시 사용할 쿠키의 길이는 최대 56자까지 가능합니다.

* HTTP Cookie (로드밸런서에 의한 세션 관리): APP Cookie 방식과 유사하지만 TOAST의 로드밸런서에서 자동적으로 설정해주는 쿠키를 통해 세션을 유지하는 방식입니다. TOAST의 로드밸런서는 서버의 응답에 [SRV Record\(서비스 레코드\)]()를 추가하여 전송하게 됩니다. 클라이언트가 SRV Record를 쿠키에 넣어서 보내면 처음에 응답한 서버로 요청이 전달됩니다.

> [주의] TOAST의 로드밸런서는 맺어진 TCP 연결을 맺을 때, 기본적으로 50초 동안 응답이 없으면 사용하지 않는다고 간주하고 자동으로 끊게 됩니다. 사용자가 TCP 연결에 대한 제한 시간을 설정하는 기능은 추후 공개될 예정입니다.

### 인스턴스 상태 확인

TOAST 로드 밸런서는 인스턴스의 정상 동작 상태 확인을 할 때 TCP, HTTP, HTTPS 프로토콜을 이용합니다. 서비스하시는 프로토콜에 따라 적절한 프로토콜을 지정하여 사용하세요.

### 과금

로드 밸런서 사용 요금은 네트워크 사용 요금과 별도로 로드 밸런서 사용 시간에 따라 과금됩니다.
트래픽 비용은 따로 내시지.
