## Network > Load Balancer > 개요

TOAST는 로드밸런서를 제공합니다. 로드밸런서를 이용하면,

- 인스턴스 하나로 처리하기 힘든 부하를 여러 대의 인스턴스로 분산하여 처리량을 늘릴 수 있습니다.
- 장애가 발생한 인스턴스를 자동으로 서비스에서 제외시켜 가용성을 높일 수 있습니다.

### 기본 구성

로드밸런서를 생성할 때, [VPC]()의 [서브넷]()을 반드시 지정해야 합니다. 지정된 서브넷으로부터 IP를 할당받아 로드밸런서의 IP로 사용하게 됩니다. 기본적으로 지정된 서브넷과 같은 VPC에 속한 인스턴스들만 멤버로 추가할 수 있으며, 멤버로 추가된 인스턴스들에게 부하를 분산하게 됩니다. 다른 VPC에 속한 인스턴스를 추가할 수 없습니다.

로드밸런서는 반드시 하나 이상의 리스너를 갖게 됩니다. 리스너는 로드밸런서로 유입되는 트래픽에 대한 정의입니다. 리스너 별로 트래픽을 수신할 포트와 프로토콜을 정의하여, 필요한 경우 로드밸런서에 리스너를 추가하거나 삭제하여 하나의 로드밸런서로 다양한 트래픽을 처리하도록 구성할 수 있습니다. 예를 들어, HTTP 트래픽을 수신할 80 포트 리스너와 HTTPS 트래픽을 수신할 443 포트 리스너를 두는 것이 대표적인 웹서버용 로드밸런서 구성입니다.

TOAST의 로드밸런서는 DSR (Direct Server Return)을 지원하지 않으며, 기본적으로 프록시 모드로만 동작합니다. 즉, 로드밸런서의 멤버인 인스턴스에서는 원본 IP가 로드밸런서의 IP로 간주 되며, 클라이언트 입장에서는 로드밸런서가 요청에 대해 응답한 것처럼 보입니다. 서버 단에서 최종사용자의 IP를 확인하려면, TOAST의 로드밸런서에서 제공하는 HTTP의 [X-Forwarded-For]() 헤더를 사용하거나, TCP의 경우 [Proxy Protocol]()을 사용하여야 합니다.

### 지원 프로토콜

TOAST의 로드밸런서는 현재 아래와 같은 프로토콜을 지원합니다.

* TCP
* HTTP
* HTTPS
* TERMINATED_HTTPS

위의 프로토콜 중 TERMINATED_HTTPS 프로토콜은 HTTPS 트래픽을 수신하여 서버 측에는 HTTP 트래픽으로 전달하는 방식입니다. TERMINATED_HTTPS 프로토콜을 사용하는 경우 최종 사용자와 로드밸런서 사이에서는 HTTPS로 통신함으로써 높은 보안성을 확보하고, 서버에게는 HTTP 트래픽을 넘겨줌으로써 복호화에 드는 서버 측 CPU 부하를 줄일 수 있습니다. 이 프로토콜을 사용하려면 반드시 인증서를 로드밸런서에 등록해야 합니다.

### 로드밸런싱 방식

TOAST는 총 세 가지 로드밸런싱 방식을 지원합니다.

* Round Robin (순차 선택): 트래픽을 전달할 인스턴스를 순차적으로 선택하는, 가장 기본적이고 대중적인 로드밸런싱 방식입니다. 멤버로 참여하는 인스턴스들이 데이터베이스를 통해 정보를 공유하는 경우나 모든 인스턴스가 같은 요청에 대해서 동일한 응답을 하는 경우에 사용할 수 있는 방식입니다.

* Least Connections (최소 연결 우선 선택): 현재 TCP 연결 수가 가장 작은 인스턴스를 선택하는 방식입니다. 즉, TCP 연결 수를 기준으로 하여 인스턴스들의 부하 상태를 파악하여 보다 균형적으로 부하가 분산될 수 있도록 합니다. 요청에 따른 처리 부하가 변동이 심할 때 적용한다면, 특정 인스턴스에 부하가 집중되는 상황을 방지할 수 있습니다.

* Source IP (원본 IP 기준 선택): 요청자의 원본 IP를 해싱하여 처리할 인스턴스를 선택하는 방식 입니다. 이 알고리즘을 사용하는 경우, 동일한 IP에서 들어오는 요청은 항상 동일한 인스턴스로 전달됩니다. 한 사용자에 대한 세션을 유지하고 똑같은 인스턴스에서 처리하고자 할 때 사용하면 유용합니다.

### 세션 지속성

(???) TOAST 로드 밸런서는 소스 IP나 쿠키로 세션을 인식하여, 한 세션에서 발생한 트래픽은 항상 같은 인스턴스로 분산시켜줄 수 있습니다. 서비스 개발자는 로드 밸런서를 고려하지 않고 서비스를 구현할 수 있게 됩니다.

### 인스턴스 상태 확인

TOAST 로드 밸런서는 인스턴스의 정상 동작 상태 확인을 할 때 TCP, HTTP, HTTPS 프로토콜을 이용합니다. 서비스하시는 프로토콜에 따라 적절한 프로토콜을 지정하여 사용하세요.

### 과금

로드 밸런서 사용 요금은 네트워크 사용 요금과 별도로 로드 밸런서 사용 시간에 따라 과금됩니다.
트래픽 비용은 따로 내시지.
